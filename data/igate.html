<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ESP32IGATE - IGATE</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="text-light bg-dark">
        <div class="container py-3">
            <h1 class=text-center><a href=/ class="text-light text-decoration-none">ESP32IGate Project [APRS ALL IN ONE]</a></h1>
        </div>
        <nav class="navbar bg-primary navbar-dark navbar-expand-lg">
            <div class=container><button class=navbar-toggler type=button aria-controls=navbarNav aria-expanded=false aria-label="Toggle navigation" data-bs-target=#navbarNav data-bs-toggle=collapse><span class=navbar-toggler-icon></span></button>
                <div class="collapse justify-content-center navbar-collapse"
                    id=navbarNav>
                    <ul class=navbar-nav>
                        <li class="nav-item"><a href="/" class="nav-link">Dashboard</a></li>
                            <li class=nav-item><a href=/radio class=nav-link>Radio</a>
                                <li class=nav-item><a href=/tnc2 class=nav-link>TNC</a>
                                    <li class=nav-item><a href=/gnss class=nav-link>GNSS</a>
                                        <li class=nav-item><a href=/igate class="nav-link active">IGATE</a>
                                            <li class=nav-item><a href=/digi class=nav-link>Digi</a>
                                                <li class=nav-item><a href=/tracker class=nav-link>Tracker</a>
                                                    <li class=nav-item><a href=/wx class=nav-link>WX</a>
                                                        <li class=nav-item><a href=/tlm class=nav-link>TLM</a>
                                                            <li class=nav-item><a href=/vpn class=nav-link>VPN</a>
                                                                <li class=nav-item><a href=/wireless class=nav-link>Wireless</a>
                                                                    <li class=nav-item><a href=/mod class=nav-link>Mod</a>
                                                                        <li class=nav-item><a href=/system class=nav-link>System</a>
                                                                            <li class=nav-item><a href=/about class=nav-link>About</a></ul>
                </div>
            </div>
        </nav>
        <div class="container mt-4" id=contentmain>
            <form action=# id=formIgate method=POST enctype=multipart/form-data>
                <div class="card mb-4">
                    <div class="card-header text-white bg-primary"><b>[IGATE] Internet Gateway Mode</b></div>
                    <div class="text-light bg-dark card-body">
                        <div class="mb-3 row"><label class="col-form-label col-sm-4 text-end"><b>Enable:</b></label>
                            <div class=col-sm-8>
                                <div class="form-check form-switch"><input name=igateEnable class=form-check-input id=igateEnable value=OK type=checkbox %igate_enable%></div>
                            </div>
                        </div>
                        <div class="mb-3 row"><label class="col-form-label col-sm-4 text-end" for=myCall><b>Station Callsign:</b></label>
                            <div class=col-sm-8><input name=myCall class=form-control id=myCall value=%MY_CALL% maxlength=7></div>
                        </div>
                        <div class="mb-3 row"><label class="col-form-label col-sm-4 text-end" for=mySSID><b>Station SSID:</b></label>
                            <div class=col-sm-8><select class=form-select id=mySSID name=mySSID><option value=0 %ssid_0_selected%>0<option value=1 %ssid_1_selected%>1<option value=2 %ssid_2_selected%>2<option value=3 %ssid_3_selected%>3<option value=4 %ssid_4_selected%>4<option value=5 %ssid_5_selected%>5<option value=6 %ssid_6_selected%>6<option value=7 %ssid_7_selected%>7<option value=8 %ssid_8_selected%>8<option value=9 %ssid_9_selected%>9<option value=10 %ssid_10_selected%>10<option value=11 %ssid_11_selected%>11<option value=12 %ssid_12_selected%>12<option value=13 %ssid_13_selected%>13<option value=14 %ssid_14_selected%>14<option value=15 %ssid_15_selected%>15</select></div>
                        </div>
                        <div class="mb-3 row"><label class="col-form-label col-sm-4 text-end"><b>Station Symbol:</b></label>
                            <div class="col-sm-8 align-items-center d-flex"><input name=igateTable class=form-control id=igateTable value=%IGATE_TABLE% maxlength=1> <input name=igateSymbol class=form-control id=igateSymbol value=%IGATE_SYMBOL% maxlength=1> <img alt=Symbol class=border id=igateImgSymbol
                                    onclick=openWindowSymbol() src=https://aprs.p00lack.cc/symbols/icons/38-1.png style=cursor:pointer width=24> <small class="text-light form-text">*Click icon for select symbol</small></div>
                        </div>
                        <div class="mb-3 row"><label class="col-form-label col-sm-4 text-end" for=igateObject><b>Item/Obj Name:</b></label>
                            <div class=col-sm-8><input name=igateObject class=form-control id=igateObject value=%IGATE_OBJECT% maxlength=9> <small class="text-light form-text">*If not used, leave it blank. Use 3-9 characters.</small></div>
                        </div>
                        <div class="mb-3 row"><label class="col-form-label col-sm-4 text-end" for=igatePath><b>PATH:</b></label>
                            <div class=col-sm-8><select class=form-select id=igatePath name=igatePath><option value=0 %igate_path_0_selected%>OFF<option value=1>DST-TRACE 1<option value=2>DST-TRACE 2<option value=3>DST-TRACE 3<option value=4>DST-TRACE 4<option value=5>TRACE1-1<option value=6>TRACE2-2<option value=7>TRACE3-3<option value=8 selected>WIDE1-1<option value=9>RFONLY<option value=10>RELAY<option value=11>GATE<option value=12>ECHO<option value=13>UserDefine 1<option value=14>UserDefine 2<option value=15>UserDefine 3<option value=16>UserDefine 4</select></div>
                        </div>
                        <div class="mb-3 row"><label class="col-form-label col-sm-4 text-end" for=aprsHost><b>Server Host:</b></label>
                            <div class=col-sm-8><input name=aprsHost class=form-control id=aprsHost value=%APRS_HOST% maxlength=20> <small class="text-light form-text">*Support APRS-IS of T2THAI at <a href=http://aprs.dprns.com:14580 target=_blank>aprs.dprns.com</a></small></div>
                        </div>
                        <div class="mb-3 row"><label class="col-form-label col-sm-4 text-end" for=aprsPort><b>Server Port:</b></label>
                            <div class=col-sm-8><input name=aprsPort class=form-control id=aprsPort value=%APRS_PORT% type=number max=65535 min=1> <small class="text-light form-text">*Support AMPR Host at <a href=http://aprs.hs5tqa.ampr.org:14580 target=_blank>aprs.hs5tqa.ampr.org</a></small></div>
                        </div>
                        <div class="mb-3 row"><label class="col-form-label col-sm-4 text-end" for=aprsFilter><b>Server Filter:</b></label>
                            <div class=col-sm-8><input name=aprsFilter class=form-control id=aprsFilter value=%APRS_FILTER% maxlength=30> <small class="text-light form-text">*Filter: <a href=http://www.aprs-is.net/javAPRSFilter.aspx target=_blank>APRS-IS Filter</a></small></div>
                        </div>
                        <div class="mb-3 row"><label class="col-form-label col-sm-4 text-end" for=igateComment><b>Text Comment:</b></label>
                            <div class=col-sm-8><input name=igateComment class=form-control id=igateComment value=%IGATE_COMMENT% maxlength=50></div>
                        </div>
                        <div class="mb-3 row"><label class="col-form-label col-sm-4 text-end"><b>RF2INET:</b></label>
                            <div class=col-sm-8>
                                <div class="form-check form-switch"><input name=rf2inetEnable class=form-check-input id=rf2inetEnable value=OK type=checkbox ></div><small class="text-light form-text">*Switch RF to Internet gateway</small></div>
                        </div>
                        <div class="mb-3 row"><label class="col-form-label col-sm-4 text-end"><b>INET2RF:</b></label>
                            <div class=col-sm-8>
                                <div class="form-check form-switch"><input name=inet2rfEnable class=form-check-input id=inet2rfEnable value=OK type=checkbox ></div><small class="text-light form-text">*Switch Internet to RF gateway</small></div>
                        </div>
                        <div class="mb-3 row"><label class="col-form-label col-sm-4 text-end"><b>Time Stamp:</b></label>
                            <div class=col-sm-8>
                                <div class="form-check form-switch"><input name=inet2rfEnable class=form-check-input id=inet2rfEnable value=OK type=checkbox></div>
                            </div>
                        </div>
                        <div class=card-body>
                            <div class="card mb-4">
                                <div class="card-header text-white bg-secondary"><b>POSITION</b></div>
                                <div class="text-light bg-dark card-body">
                                    <div class="mb-3 row"><label class="col-form-label col-sm-4 text-end" for=igateBeaconEnable><b>Beacon:</b></label>
                                        <div class=col-sm-8>
                                            <div class="form-check form-switch"><input name=igateBeaconEnable class=form-check-input id=igateBeaconEnable value=OK type=checkbox></div><small class="text-light form-text">Enable or disable beacon</small></div>
                                    </div>
                                    <div class="mb-3 row"><label class="col-form-label col-sm-4 text-end" for=igatePosInv><b>Beacon Interval:</b></label>
                                        <div class=col-sm-8><input name=igatePosInv class=form-control id=igatePosInv value=600 type=number max=3600 min=0> <small class="text-light form-text">Interval in seconds</small></div>
                                    </div>
                                    <div class="mb-3 row"><label class="col-form-label col-sm-4 text-end"><b>Location:</b></label>
                                        <div class=col-sm-8>
                                            <div class="form-check form-check-inline"><input name=igatePosSel class=form-check-input id=igatePosFix value=0 type=radio checked> <label class=form-check-label for=igatePosFix>Fix</label></div>
                                            <div class="form-check form-check-inline"><input name=igatePosSel class=form-check-input id=igatePosGPS value=1 type=radio> <label class=form-check-label for=igatePosGPS>GPS</label></div>
                                        </div>
                                    </div>
                                    <div class="mb-3 row"><label class="col-form-label col-sm-4 text-end"><b>TX Channel:</b></label>
                                        <div class=col-sm-8>
                                            <div class="form-check form-check-inline"><input name=igatePos2RF class=form-check-input id=igatePos2RF value=OK type=checkbox> <label class=form-check-label for=igatePos2RF>RF</label></div>
                                            <div class="form-check form-check-inline"><input name=igatePos2INET class=form-check-input id=igatePos2INET value=OK type=checkbox > <label class=form-check-label for=igatePos2INET>Internet</label></div>
                                        </div>
                                    </div>
                                    <div class="mb-3 row"><label class="col-form-label col-sm-4 text-end" for=igatePosLat><b>Latitude:</b></label>
                                        <div class=col-sm-8><input name=igatePosLat class=form-control id=igatePosLat value=%IGATE_LAT% type=number max=90 min=-90 step=0.00001> <small class="text-light form-text">Degrees (positive for North, negative for South)</small></div>
                                    </div>
                                    <div class="mb-3 row"><label class="col-form-label col-sm-4 text-end" for=igatePosLon><b>Longitude:</b></label>
                                        <div class=col-sm-8><input name=igatePosLon class=form-control id=igatePosLon value=%IGATE_LON% type=number max=180 min=-180 step=0.00001> <small class="text-light form-text">Degrees (positive for East, negative for West)</small></div>
                                    </div>
                                    <div class="mb-3 row"><label class="col-form-label col-sm-4 text-end" for=igatePosAlt><b>Altitude:</b></label>
                                        <div class=col-sm-8><input name=igatePosAlt class=form-control id=igatePosAlt value=%IGATE_ALT% type=number max=10000 min=0 step=0.1> <small class="text-light form-text">Meter. Value 0 will not send height</small></div>
                                    </div>
                                </div>
                            </div>
                            <div class="card mb-4">
                                <div class="card-header text-white bg-secondary"><b>PHG</b></div>
                                <div class="text-light bg-dark card-body">
                                    <div class="mb-3 row"><label class="col-form-label col-sm-4 text-end" for=power><b>Radio TX Power:</b></label>
                                        <div class=col-sm-8><select class=form-select id=power name=power><option value=1 %power_1_selected%>1<option value=5 %power_5_selected%>5<option value=10 %power_10_selected%>10<option value=15 %power_15_selected%>15<option value=25 %power_25_selected%>25<option value=35 %power_35_selected%>35<option value=50 %power_50_selected%>50<option value=65 %power_65_selected%>65<option value=80 %power_80_selected%>80</select>                                            <small class="text-light form-text">Watts</small></div>
                                    </div>
                                    <div class="mb-3 row"><label class="col-form-label col-sm-4 text-end" for=phgGain><b>Antenna Gain:</b></label>
                                        <div class=col-sm-8><input name="phgGain" class="form-control" id="phgGain" value="6" type="number" min="0" max="9">dBi</small></div>
                                    </div>
                                    <div class="mb-3 row"><label class="col-form-label col-sm-4 text-end" for=haat><b>Height:</b></label>
                                        <div class=col-sm-8><select class=form-select id=haat name=haat><option value=10 %haat_10_selected%>10<option value=20 %haat_20_selected%>20<option value=40 %haat_40_selected%>40<option value=80 %haat_80_selected%>80<option value=160 %haat_160_selected%>160<option value=320 %haat_320_selected%>320<option value=640 %haat_640_selected%>640<option value=1280 %haat_1280_selected%>1280<option value=2560 %haat_2560_selected%>2560<option value=5120 %haat_5120_selected%>5120</select>                                            <small class="text-light form-text">Feet</small></div>
                                    </div>
                                    <div class="mb-3 row"><label class="col-form-label col-sm-4 text-end" for=phgDirection><b>Antenna/Direction:</b></label>
                                        <div class=col-sm-8><select class=form-select id=phgDirection name=phgDirection><option value=Omni %direction_omni_selected%>Omni<option value=NE %direction_ne_selected%>NE<option value=E %direction_e_selected%>E<option value=SE %direction_se_selected%>SE<option value=S %direction_s_selected%>S<option value=SW %direction_sw_selected%>SW<option value=W %direction_w_selected%>W<option value=NW %direction_nw_selected%>NW<option value=N %direction_n_selected%>N</select></div>
                                    </div>
                                    <div class="mb-3 row"><label class="col-form-label col-sm-4 text-end" for=phgText><b>PHG Text:</b></label>
                                        <div class=col-sm-6><input name=phgText class=form-control id=phgText value=%PHG_TEXT%></div>
                                        <div class=col-sm-2><button class="btn btn-secondary" type=button onclick=calculatePHG()>Calculate PHG</button></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-3"><button class="btn btn-primary" type=submit id=submitIGATE name=commitIGATE>Apply Changes</button></div><input name=commitIGATE type=hidden></form>
            <form action=# id=formIgateFilter method=POST class=mt-4>
                <div class=card>
                    <div class="card-header text-white bg-secondary"><b>[IGATE] Filter</b></div>
                    <div class="text-light bg-dark card-body">
                        <fieldset>
                            <legend class=mb-3><b>RF2INET Filter: Filter RF to Internet</b></legend>
                            <div class=row>
                                <div class=col-md-3>
                                    <div class=form-check><input name=rf2inetFilterMessage class=form-check-input id=rf2inetFilterMessage value=OK type=checkbox %rf2inet_filter_message%> <label class=form-check-label for=rf2inetFilterMessage>Message</label></div>
                                    <div class=form-check><input name=rf2inetFilterStatus class=form-check-input id=rf2inetFilterStatus value=OK type=checkbox> <label class=form-check-label for=rf2inetFilterStatus>Status</label></div>
                                </div>
                                <div class=col-md-3>
                                    <div class=form-check><input name=rf2inetFilterTelemetry class=form-check-input id=rf2inetFilterTelemetry value=OK type=checkbox> <label class=form-check-label for=rf2inetFilterTelemetry>Telemetry</label></div>
                                    <div class=form-check><input name=rf2inetFilterWeather class=form-check-input id=rf2inetFilterWeather value=OK type=checkbox> <label class=form-check-label for=rf2inetFilterWeather>Weather</label></div>
                                </div>
                                <div class=col-md-3>
                                    <div class=form-check><input name=rf2inetFilterObject class=form-check-input id=rf2inetFilterObject value=OK type=checkbox > <label class=form-check-label for=rf2inetFilterObject>Object</label></div>
                                    <div class=form-check><input name=rf2inetFilterItem class=form-check-input id=rf2inetFilterItem value=OK type=checkbox > <label class=form-check-label for=rf2inetFilterItem>Item</label></div>
                                </div>
                                <div class=col-md-3>
                                    <div class=form-check><input name=rf2inetFilterQuery class=form-check-input id=rf2inetFilterQuery value=OK type=checkbox > <label class=form-check-label for=rf2inetFilterQuery>Query</label></div>
                                    <div class=form-check><input name=rf2inetFilterBuoy class=form-check-input id=rf2inetFilterBuoy value=OK type=checkbox > <label class=form-check-label for=rf2inetFilterBuoy>Buoy</label></div>
                                </div>
                                <div class=col-md-3>
                                    <div class=form-check><input name=rf2inetFilterPosition class=form-check-input id=rf2inetFilterPosition value=OK type=checkbox > <label class=form-check-label for=rf2inetFilterPosition>Position</label></div>
                                </div>
                            </div>
                        </fieldset>
                        <hr>
                        <fieldset>
                            <legend class=mb-3><b>INET2RF Filter: Filter Internet to RF</b></legend>
                            <div class=row>
                                <div class=col-md-3>
                                    <div class=form-check><input name=inet2rfFilterMessage class=form-check-input id=inet2rfFilterMessage value=OK type=checkbox %inet2rf_filter_message%> <label class=form-check-label for=inet2rfFilterMessage>Message</label></div>
                                    <div class=form-check><input name=inet2rfFilterStatus class=form-check-input id=inet2rfFilterStatus value=OK type=checkbox> <label class=form-check-label for=inet2rfFilterStatus>Status</label></div>
                                </div>
                                <div class=col-md-3>
                                    <div class=form-check><input name=inet2rfFilterTelemetry class=form-check-input id=inet2rfFilterTelemetry value=OK type=checkbox> <label class=form-check-label for=inet2rfFilterTelemetry>Telemetry</label></div>
                                    <div class=form-check><input name=inet2rfFilterWeather class=form-check-input id=inet2rfFilterWeather value=OK type=checkbox> <label class=form-check-label for=inet2rfFilterWeather>Weather</label></div>
                                </div>
                                <div class=col-md-3>
                                    <div class=form-check><input name=inet2rfFilterObject class=form-check-input id=inet2rfFilterObject value=OK type=checkbox> <label class=form-check-label for=inet2rfFilterObject>Object</label></div>
                                    <div class=form-check><input name=inet2rfFilterItem class=form-check-input id=inet2rfFilterItem value=OK type=checkbox> <label class=form-check-label for=inet2rfFilterItem>Item</label></div>
                                </div>
                                <div class=col-md-3>
                                    <div class=form-check><input name=inet2rfFilterQuery class=form-check-input id=inet2rfFilterQuery value=OK type=checkbox> <label class=form-check-label for=inet2rfFilterQuery>Query</label></div>
                                    <div class=form-check><input name=inet2rfFilterBuoy class=form-check-input id=inet2rfFilterBuoy value=OK type=checkbox> <label class=form-check-label for=inet2rfFilterBuoy>Buoy</label></div>
                                </div>
                                <div class=col-md-3>
                                    <div class=form-check><input name=inet2rfFilterPosition class=form-check-input id=inet2rfFilterPosition value=OK type=checkbox> <label class=form-check-label for=inet2rfFilterPosition>Position</label></div>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                </div>
                <div class="text-center mt-3"><button class="btn btn-secondary" type=submit id=submitIGATEfilter name=commitIGATEfilter>Apply Filters</button></div>
            </form>
        </div>
        <footer class="text-light bg-primary mt-5 py-3 text-center">ESP32IGate Web Configuration - © 2025</footer>
        <script>
            async function loadConfig() {
                const response = await fetch('/igate/settings', {
                        method: 'GET'
                    }

                );
                const config = await response.json();
                document.getElementById('igateEnable').checked = config.igateEnable;
                document.getElementById('callsign').value = config.callsign || '';
                document.getElementById('mySSID').value = config.mySSID || '';
                document.getElementById('server').value = config.server || '';
                document.getElementById('port').value = config.port || '';
                document.getElementById('serverFilter').value = config.serverFilter || '';
                document.getElementById('textComment').value = config.textComment || '';
                document.getElementById('latitude').value = config.latitude || '';
                document.getElementById('longitude').value = config.longitude || '';
                document.getElementById('altitude').value = config.altitude || '';
                document.getElementById('txPower').value = config.txPower || '';
                document.getElementById('antennaGain').value = config.antennaGain || '';
                document.getElementById('height').value = config.height || '';
                document.getElementById('rf2inetMessage').checked = config.rf2inetMessage;
                document.getElementById('rf2inetTelemetry').checked = config.rf2inetTelemetry;
                document.getElementById('inet2rfMessage').checked = config.inet2rfMessage;
                document.getElementById('inet2rfTelemetry').checked = config.inet2rfTelemetry;
            }

            async function saveConfig() {
                const form = document.getElementById('igateForm');
                const formData = new FormData(form);
                const config = {};
                formData.forEach((value, key) => {
                    config[key] = value;
                });
                await fetch('/igate/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                alert('Configuration saved!');
            }

            window.onload = loadConfig;
        </script>
        <script>
            function openWindowSymbol() {
                window.open("/symbol", null, "height=400,width=400,status=no,toolbar=no,menubar=no,titlebar=no,location=no");
            }

            function setValue(symbol, table) {
                document.getElementById("igateSymbol").value = String.fromCharCode(symbol);
                document.getElementById("igateTable").value = table === 1 ? "/" : "\\";
                document.getElementById("igateImgSymbol").src = `http: //aprs.dprns.com/symbols/icons/${symbol}-${table}.png`;
            }

            function calculatePHG() {
            // Obtener valores de entrada
            const power = parseFloat(document.getElementById("power").value) || 0; // Radio TX Power
            const height = parseFloat(document.getElementById("haat").value) || 0; // Height Above Average Terrain (HAAT)
            const gain = parseFloat(document.getElementById("phgGain").value) || 0; // Antenna Gain
            const direction = document.getElementById("phgDirection").value || "Omni"; // Antenna Direction

            // Función para calcular el valor de potencia
            function calcPower(power) {
                if (power < 1) return "0";
                if (power < 4) return "1";
                if (power < 9) return "2";
                if (power < 16) return "3";
                if (power < 25) return "4";
                if (power < 36) return "5";
                if (power < 49) return "6";
                if (power < 64) return "7";
                if (power < 81) return "8";
                return "9";
            }

            // Función para calcular el valor de altura
            function calcHeight(height) {
                if (height < 10) return "0"; // Altura mínima válida
                return String.fromCharCode(48 + Math.round(Math.log2(height / 10)));
            }

            // Función para calcular la ganancia
            function calcGain(gain) {
                return Math.min(Math.max(Math.round(gain), 0), 9).toString();
            }

            // Función para calcular la dirección
            function calcDirection(direction) {
                if (direction === "Omni") return "O";
                return direction[0].toUpperCase(); // Primera letra en mayúscula
            }

            // Construir el valor PHG
            const phg =
                "PHG" +
                calcPower(power) +
                calcHeight(height) +
                calcGain(gain) +
                calcDirection(direction);

            // Mostrar el resultado en el campo de texto
            document.getElementById("phgText").value = phg;

            // Log para depuración
            console.log("PHG Calculado:", phg);
        }
        </script>