<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/highcharts-more.js"></script>
    <title>ESP32IGATE - TNC - Last Heard</title>
    <style>
        #vumeter {
            width: 300px;
            height: 200px;
            margin: 20px auto;
        }
        #raw_txt {
            width: 100%;
            height: 400px;
            margin-top: 20px;
        }
    </style>
    <script>
        $(document).ready(function() {
            var chart = {
                type: 'gauge',
                plotBorderWidth: 1,
                plotBackgroundColor: {
                    linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1 },
                    stops: [[0, '#FFFFC6'], [0.3, '#FFFFFF'], [1, '#FFF4C6']]
                },
                plotBackgroundImage: null,
                height: 200
            };
            var credits = { enabled: false };
            var title = { text: 'RX VU Meter' };
            var pane = [{
                startAngle: -45,
                endAngle: 45,
                background: null,
                center: ['50%', '145%'],
                size: 300
            }];
            var yAxis = [{
                min: -40,
                max: 1,
                minorTickPosition: 'outside',
                tickPosition: 'outside',
                labels: { rotation: 'auto', distance: 20 },
                plotBands: [
                    { from: -10, to: 1, color: '#C02316', innerRadius: '100%', outerRadius: '105%' },
                    { from: -20, to: -10, color: '#00C000', innerRadius: '100%', outerRadius: '105%' },
                    { from: -30, to: -20, color: '#AFFF0F', innerRadius: '100%', outerRadius: '105%' },
                    { from: -40, to: -30, color: '#C0A316', innerRadius: '100%', outerRadius: '105%' }
                ],
                pane: 0,
                title: { text: '<span style="font-size:12px">dBV</span>', y: -40 }
            }];
            var plotOptions = { gauge: { dataLabels: { enabled: false }, dial: { radius: '100%' } } };
            var series = [{ data: [-40], yAxis: 0 }];
            var json = { chart, credits, title, pane, yAxis, plotOptions, series };

            var chartFunction = function(chart) {
                var Vrms = 0, dBV = -40, active = 0, raw = "", timeStamp;
                if (chart.series) {
                    var left = chart.series[0].points[0];
                    var host = 'ws://' + location.hostname + ':81/ws';
                    const ws = new WebSocket(host);
                    ws.onopen = function() { console.log('Connection opened'); };
                    ws.onclose = function() { console.log('Connection closed'); };
                    ws.onmessage = function(event) {
                        const jsonR = JSON.parse(event.data);
                        active = parseInt(jsonR.Active);
                        Vrms = parseFloat(jsonR.mVrms) / 1000;
                        dBV = 20.0 * Math.log10(Vrms);
                        if (dBV < -40) dBV = -40;
                        raw = jsonR.RAW;
                        timeStamp = Number(jsonR.timeStamp);
                        if (active == 1) {
                            left.update(dBV, false);
                            chart.redraw();
                            var date = new Date(timeStamp * 1000);
                            var head = date + "[" + Vrms.toFixed(3) + "Vrms, " + dBV.toFixed(1) + "dBV]\n";
                            var textArea = document.getElementById("raw_txt");
                            textArea.value += head + atob(raw) + "\n";
                            textArea.scrollTop = textArea.scrollHeight;
                        }
                    };
                }
            };
            $('#vumeter').highcharts(json, chartFunction);
        });
    </script>
</head>
<body class="bg-dark text-light">

    <!-- Header -->
    <div class="container py-3">
        <h1 class="text-center">
            <a href="/" class="text-decoration-none text-light">ESP32IGate Project [APRS ALL IN ONE]</a>
        </h1>
    </div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-center" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="/dashboard">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="/radio">Radio</a></li>
                    <li class="nav-item"><a class="nav-link" href="/tnc2">TNC</a></li>
                    <li class="nav-item"><a class="nav-link" href="/igate">IGATE</a></li>
                    <li class="nav-item"><a class="nav-link" href="/digi">Digi</a></li>
                    <li class="nav-item"><a class="nav-link" href="/tracker">Tracker</a></li>
                    <li class="nav-item"><a class="nav-link" href="/wx">WX</a></li>
                    <li class="nav-item"><a class="nav-link" href="/tlm">TLM</a></li>
                    <li class="nav-item"><a class="nav-link" href="/vpn">VPN</a></li>
                    <li class="nav-item"><a class="nav-link" href="/wireless">Wireless</a></li>
                    <li class="nav-item"><a class="nav-link" href="/mod">Mod</a></li>
                    <li class="nav-item"><a class="nav-link" href="/system">System</a></li>
                    <li class="nav-item"><a class="nav-link" href="/about">About</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <div id="vumeter"></div>
        <div>
            <label for="raw_txt" class="form-label">Terminal</label>
            <textarea id="raw_txt" name="raw_txt" rows="20" class="form-control"></textarea>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-primary text-center text-light py-3 mt-4">
        ESP32IGate Web Configuration - &copy; 2025
    </footer>
</body>
</html>
